<!DOCTYPE html>
<html>
<head>
  <title>Booking Form</title>
  <meta charset="UTF-8">
</head>
<body>
  <h2>Apartment Booking Form</h2>

  <form id="bookingForm">
    <label>Project Name:
      <select id="project" name="Project Name" required>
        <option value="">--Select Project--</option>
      </select>
    </label><br><br>

    <label>Block Number:
      <select id="block" name="Block Number" required>
        <option value="">--Select Block--</option>
      </select>
    </label><br><br>

    <label>Flat Number:
      <select id="flat" name="Flat Number" required>
        <option value="">--Select Flat--</option>
      </select>
    </label><br><br>

    <label>Saleable Area:
      <input type="text" id="saleableArea" name="Saleable Area" readonly>
    </label><br><br>

    <label>Facing:
      <input type="text" id="facing" name="Facing" readonly>
    </label><br><br>

    <label>Full Name:
      <input type="text" name="Full Name" required>
    </label><br><br>

    <label>Mobile Number:
      <input type="text" name="Mobile Number" required>
    </label><br><br>

    <button type="submit">Submit</button>
  </form>

  <script>
    const scriptURL = 'https://script.google.com/macros/s/AKfycby9FKSO8OIQSrAewqqNGVxLdVfN1iQYTco2dSrHIDpiXaNbq0Q57u6JNN7ZPQhA72-EpQ/exec';
    let lookupData = [];

    async function loadLookupData() {
      try {
        const res = await fetch(scriptURL + '?action=getLookupData');
        lookupData = await res.json();

        const projectSet = new Set(lookupData.map(row => row.projectname));
        populate(document.getElementById('project'), [...projectSet]);
      } catch (err) {
        alert("Failed to load data");
        console.error(err);
      }
    }

    function populate(select, options) {
      select.innerHTML = '<option value="">--Select--</option>';
      options.forEach(opt => {
        const option = document.createElement('option');
        option.value = opt;
        option.text = opt;
        select.appendChild(option);
      });
    }

    document.getElementById('project').addEventListener('change', () => {
      const project = document.getElementById('project').value;
      const blocks = lookupData
        .filter(d => d.projectname === project)
        .map(d => d.blocknumber);
      populate(document.getElementById('block'), [...new Set(blocks)]);
      document.getElementById('flat').innerHTML = '<option value="">--Select Flat--</option>';
    });

    document.getElementById('block').addEventListener('change', () => {
      const project = document.getElementById('project').value;
      const block = document.getElementById('block').value;
      const flats = lookupData
        .filter(d => d.projectname === project && d.blocknumber === block)
        .map(d => d.flatnumber);
      populate(document.getElementById('flat'), [...new Set(flats)]);
    });

    document.getElementById('flat').addEventListener('change', () => {
      const project = document.getElementById('project').value;
      const block = document.getElementById('block').value;
      const flat = document.getElementById('flat').value;
      const match = lookupData.find(d =>
        d.projectname === project && d.blocknumber === block && d.flatnumber === flat
      );
      if (match) {
        document.getElementById('saleableArea').value = match.saleablearea;
        document.getElementById('facing').value = match.facing;
      }
    });

    document.getElementById('bookingForm').addEventListener('submit', async e => {
      e.preventDefault();
      const formData = new FormData(e.target);
      const formObj = {};
      formData.forEach((v, k) => formObj[k] = v);

      const res = await fetch(scriptURL, {
        method: 'POST',
        body: JSON.stringify(formObj),
        headers: { 'Content-Type': 'application/json' }
      });

      if (res.ok) {
        alert('Form submitted!');
        e.target.reset();
      } else {
        alert('Submission failed.');
      }
    });

    loadLookupData();
  </script>
</body>
</html>
